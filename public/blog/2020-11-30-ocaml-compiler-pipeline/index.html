<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Going through the OCaml compiler pipeline (manually) | Dev.Poga</title>
<meta name="keywords" content="OCaml, Compiler, Programming, Learn OCaml the Hard Way">
<meta name="description" content="Modern compilers usually composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let&rsquo;s go through it one by one to have a better understanding of the OCaml compiler.">
<meta name="author" content="poga">
<link rel="canonical" href="https://devpoga.org/blog/2020-11-30-ocaml-compiler-pipeline/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://devpoga.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://devpoga.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://devpoga.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://devpoga.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://devpoga.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Going through the OCaml compiler pipeline (manually)" />
<meta property="og:description" content="Modern compilers usually composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let&rsquo;s go through it one by one to have a better understanding of the OCaml compiler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devpoga.org/blog/2020-11-30-ocaml-compiler-pipeline/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-30T00:00:00+08:00" />
<meta property="article:modified_time" content="2020-11-30T00:00:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Going through the OCaml compiler pipeline (manually)"/>
<meta name="twitter:description" content="Modern compilers usually composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let&rsquo;s go through it one by one to have a better understanding of the OCaml compiler."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://devpoga.org/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Going through the OCaml compiler pipeline (manually)",
      "item": "https://devpoga.org/blog/2020-11-30-ocaml-compiler-pipeline/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Going through the OCaml compiler pipeline (manually)",
  "name": "Going through the OCaml compiler pipeline (manually)",
  "description": "Modern compilers usually composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let\u0026rsquo;s go through it one by one to have a better understanding of the OCaml compiler.",
  "keywords": [
    "OCaml", "Compiler", "Programming", "Learn OCaml the Hard Way"
  ],
  "articleBody": "Learn OCaml the Hard Way is a series about learning OCaml from the ground up:\nA taste of OCaml’s predictable performance Going through the OCaml compiler pipeline (manually) (You’re here) Predictable Performance of OCaml’s module system Modern compilers are composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let’s go through it one by one to have a better understanding of the OCaml compiler. Here’s the OCaml’s compilation pipeline:\nsource: https://dev.realworldocaml.org/compiler-frontend.html\nFrom Real World OCaml:\nEach source file represents a compilation unit that is built separately. The compiler generates intermediate files with different filename extensions to use as it advances through the compilation stages. The linker takes a collection of compiled units and produces a standalone executable or library archive that can be reused by other applications.\nWe can easily go through intermediate representations via poking into these files.\nAbstract Syntax Tree (AST) OCaml’s metaprogramming ability relies on manipulating ASTs (Parsetrees). ppx_tools is a set of tools for people who want to write programs with such ability. We can use it to obtain the AST of a source code.\nAssume we have the following OCaml code:\ntype t = | Alice | Bob | Charlie | David let test v = match v with | Alice -\u003e 100 | Bob -\u003e 101 | Charlie -\u003e 102 | David -\u003e 103 We can get the AST of it via the following command:\n$ $ ocamlfind ppx_tools/dumpast t.ml t.ml ==\u003e [{pstr_desc = Pstr_type (Recursive, [{ptype_name = {txt = \"t\"}; ptype_params = []; ptype_cstrs = []; ptype_kind = Ptype_variant [{pcd_name = {txt = \"Alice\"}; pcd_args = Pcstr_tuple []; pcd_res = None}; {pcd_name = {txt = \"Bob\"}; pcd_args = Pcstr_tuple []; pcd_res = None}; {pcd_name = {txt = \"Charlie\"}; pcd_args = Pcstr_tuple []; pcd_res = None}; {pcd_name = {txt = \"David\"}; pcd_args = Pcstr_tuple []; pcd_res = None}]; ptype_private = Public; ptype_manifest = None}])}; {pstr_desc = Pstr_value (Nonrecursive, [{pvb_pat = {ppat_desc = Ppat_var {txt = \"test\"}; ppat_loc_stack = []}; pvb_expr = {pexp_desc = Pexp_fun (Nolabel, None, {ppat_desc = Ppat_var {txt = \"v\"}; ppat_loc_stack = []}, {pexp_desc = Pexp_match ({pexp_desc = Pexp_ident {txt = Lident \"v\"}; pexp_loc_stack = []}, [{pc_lhs = {ppat_desc = Ppat_construct ({txt = Lident \"Alice\"}, None); ppat_loc_stack = []}; pc_guard = None; pc_rhs = {pexp_desc = Pexp_constant (Pconst_integer (\"100\", None)); pexp_loc_stack = []}}; {pc_lhs = {ppat_desc = Ppat_construct ({txt = Lident \"Bob\"}, None); ppat_loc_stack = []}; pc_guard = None; pc_rhs = {pexp_desc = Pexp_constant (Pconst_integer (\"101\", None)); pexp_loc_stack = []}}; {pc_lhs = {ppat_desc = Ppat_construct ({txt = Lident \"Charlie\"}, None); ppat_loc_stack = []}; pc_guard = None; pc_rhs = {pexp_desc = Pexp_constant (Pconst_integer (\"102\", None)); pexp_loc_stack = []}}; {pc_lhs = {ppat_desc = Ppat_construct ({txt = Lident \"David\"}, None); ppat_loc_stack = []}; pc_guard = None; pc_rhs = {pexp_desc = Pexp_constant (Pconst_integer (\"103\", None)); pexp_loc_stack = []}}]); pexp_loc_stack = []}); pexp_loc_stack = []}}])}] ========= The output is pretty straight forward. The Parsetree documentation is a good reference to understand it.\nTypedtree For the simplicity of the article, we will skip the detail of type inferencing and checking here. They will (hopefully) be explained in the future.\nLambda The first code generation phase in the OCaml pipeline is to create a Lambda Form. Lambda form discards higher-level constructs such as modules, pattern matching, and objects.\nModules and objects are replaced with records and function pointers. Pattern Matchings are compiled into optimized automatas. Block and values are mapped to the runtime memory model. We can obtain the lambda form via the following command:\n$ ocamlc -dlambda -c t.ml (setglobal T! (let (test/85 = (function v/87 : int (switch* v/87 case int 0: 100 case int 1: 101 case int 2: 102 case int 3: 103))) (makeblock 0 test/85))) Lambda Form is explicitly undocumented and can change across compiler revisions.\nFor more detail, see The Compiler Backend: Bytecode and Native code - Real World OCaml.\nWe can generate both bytecodes and native binaries from the Lambda Form.\nBytecode and js_of_ocaml We can obtain the bytecode with the following command:\n$ ocamlc -dinstr t.ml branch L2 L1:\tacc 0 switch 6 5 4 3/ L6:\tconst 100 return 1 L5:\tconst 101 return 1 L4:\tconst 102 return 1 L3:\tconst 103 return 1 L2:\tclosure L1, 0 push acc 0 makeblock 1, 0 pop 1 setglobal T! The bytecode can be executed with ocamlrun, a portable interpreter for OCaml’s bytecode.\nThe OCaml bytecode is based on a stack-based VM. The instruction set of the Caml Virtual Machine is documented here.\nSince the OCaml bytecode is quite stable. We can generate a target-specified code (such as Javascript for the web) from it without recompiling any library.\njs_of_ocaml is a compiler from OCaml bytecode programs to Javascript. Caramel is an Erlang backend to the OCaml compiler. Here’s a simple example of using js_of_ocaml:\n$ ocamlfind ocamlc -package js_of_ocaml -package js_of_ocaml-ppx \\ -linkpkg -o t.byte t.ml $ js_of_ocaml t.byte Native Compilation Finally, we can generate native binaries with ocamlopt t.ml. You can get ocamlopt to output the assembly with the -S flag.\nIf we want the best performance (and we usually does). We should use the compiler with flambda optimizers. you can install a flambda-optimized OCaml with opam switch, such as:\n$ opam switch create 4.11.1+flambda Extra: Top-level The OCaml top-level supports loading both source code or bytecodes. To load a source code, use the #mod_use command. To load a bytecode, use #load.\nReferences The OCaml Compiler Pipeline The Compiler Frontend: Parsing and Type Checking The Compiler Backend: Bytecode and Native code An introduction to OCaml PPX ecosystem Like this post? Subscribe to Learn OCaml the Hard Way to get more!\n",
  "wordCount" : "930",
  "inLanguage": "en",
  "datePublished": "2020-11-30T00:00:00+08:00",
  "dateModified": "2020-11-30T00:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "poga"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://devpoga.org/blog/2020-11-30-ocaml-compiler-pipeline/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dev.Poga",
    "logo": {
      "@type": "ImageObject",
      "url": "https://devpoga.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://devpoga.org/" accesskey="h" title="Dev.Poga (Alt + H)">Dev.Poga</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://devpoga.org/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://devpoga.org/">Home</a>&nbsp;»&nbsp;<a href="https://devpoga.org/blog/">Blogs</a></div>
    <h1 class="post-title">
      Going through the OCaml compiler pipeline (manually)
    </h1>
    <div class="post-meta"><span title='2020-11-30 00:00:00 +0800 CST'>November 30, 2020</span>&nbsp;·&nbsp;poga

</div>
  </header> 
  <div class="post-content"><p><strong><a href="/tags/learn-ocaml-the-hard-way/">Learn OCaml the Hard Way</a> is a series about learning OCaml from the ground up:</strong></p>
<ul>
<li><a href="/post/2020-11-21-a-taste-of-ocaml-predictable-performance/">A taste of OCaml&rsquo;s predictable performance</a></li>
<li><a href="/post/2020-11-30-ocaml-compiler-pipeline/">Going through the OCaml compiler pipeline (manually)</a> <strong>(You&rsquo;re here)</strong></li>
<li><a href="/post/2020-12-19_ocaml_predictable_module_functor/">Predictable Performance of OCaml&rsquo;s module system</a></li>
</ul>
<hr>
<p>Modern compilers are composed by multiple stages: parsers, optimizers, linkers, and assemblers. Let&rsquo;s go through it one by one to have a better understanding of the OCaml compiler. Here&rsquo;s the OCaml&rsquo;s compilation pipeline:</p>
<p><img loading="lazy" src="/post/2020-11-30-ocaml-compiler-pipeline/ocaml-pipeline.png" alt=""  />
</p>
<p>source: <a href="https://dev.realworldocaml.org/compiler-frontend.html">https://dev.realworldocaml.org/compiler-frontend.html</a></p>
<p>From Real World OCaml:</p>
<blockquote>
<p>Each source file represents a <em>compilation unit</em> that is built separately. The compiler generates intermediate files with different filename extensions to use as it advances through the compilation stages. The linker takes a collection of compiled units and produces a standalone executable or library archive that can be reused by other applications.</p>
</blockquote>
<p>We can easily go through intermediate representations via poking into these files.</p>
<hr>
<h2 id="abstract-syntax-tree-ast">Abstract Syntax Tree (AST)<a hidden class="anchor" aria-hidden="true" href="#abstract-syntax-tree-ast">#</a></h2>
<p>OCaml&rsquo;s metaprogramming ability relies on manipulating ASTs (Parsetrees). <a href="https://github.com/ocaml-ppx/ppx_tools">ppx_tools</a> is a set of tools for people who want to write programs with such ability. We can use it to obtain the AST of a source code.</p>
<p>Assume we have the following OCaml code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> t <span style="color:#f92672">=</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Alice</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Bob</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Charlie</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">David</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> test v <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">match</span> v <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">Alice</span>   <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">Bob</span>     <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">Charlie</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">102</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">David</span>   <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">103</span>
</span></span></code></pre></div><p>We can get the AST of it via the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ $ ocamlfind ppx_tools/dumpast t.ml
</span></span><span style="display:flex;"><span>t.ml
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[{</span>pstr_desc <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>   Pstr_type <span style="color:#f92672">(</span>Recursive,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[{</span>ptype_name <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;t&#34;</span><span style="color:#f92672">}</span>; ptype_params <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>; ptype_cstrs <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>      ptype_kind <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>       Ptype_variant
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[{</span>pcd_name <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Alice&#34;</span><span style="color:#f92672">}</span>; pcd_args <span style="color:#f92672">=</span> Pcstr_tuple <span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>          pcd_res <span style="color:#f92672">=</span> None<span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">{</span>pcd_name <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bob&#34;</span><span style="color:#f92672">}</span>; pcd_args <span style="color:#f92672">=</span> Pcstr_tuple <span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>          pcd_res <span style="color:#f92672">=</span> None<span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">{</span>pcd_name <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Charlie&#34;</span><span style="color:#f92672">}</span>; pcd_args <span style="color:#f92672">=</span> Pcstr_tuple <span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>          pcd_res <span style="color:#f92672">=</span> None<span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">{</span>pcd_name <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;David&#34;</span><span style="color:#f92672">}</span>; pcd_args <span style="color:#f92672">=</span> Pcstr_tuple <span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>          pcd_res <span style="color:#f92672">=</span> None<span style="color:#f92672">}]</span>;
</span></span><span style="display:flex;"><span>      ptype_private <span style="color:#f92672">=</span> Public; ptype_manifest <span style="color:#f92672">=</span> None<span style="color:#f92672">}])}</span>;
</span></span><span style="display:flex;"><span> <span style="color:#f92672">{</span>pstr_desc <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>   Pstr_value <span style="color:#f92672">(</span>Nonrecursive,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[{</span>pvb_pat <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_var <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">}</span>; ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>;
</span></span><span style="display:flex;"><span>      pvb_expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>         Pexp_fun <span style="color:#f92672">(</span>Nolabel, None,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_var <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;v&#34;</span><span style="color:#f92672">}</span>; ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            Pexp_match
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">({</span>pexp_desc <span style="color:#f92672">=</span> Pexp_ident <span style="color:#f92672">{</span>txt <span style="color:#f92672">=</span> Lident <span style="color:#e6db74">&#34;v&#34;</span><span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>               pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">[{</span>pc_lhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_construct <span style="color:#f92672">({</span>txt <span style="color:#f92672">=</span> Lident <span style="color:#e6db74">&#34;Alice&#34;</span><span style="color:#f92672">}</span>, None<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                 ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>;
</span></span><span style="display:flex;"><span>               pc_guard <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>               pc_rhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span> Pexp_constant <span style="color:#f92672">(</span>Pconst_integer <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;100&#34;</span>, None<span style="color:#f92672">))</span>;
</span></span><span style="display:flex;"><span>                 pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}}</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">{</span>pc_lhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_construct <span style="color:#f92672">({</span>txt <span style="color:#f92672">=</span> Lident <span style="color:#e6db74">&#34;Bob&#34;</span><span style="color:#f92672">}</span>, None<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                 ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>;
</span></span><span style="display:flex;"><span>               pc_guard <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>               pc_rhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span> Pexp_constant <span style="color:#f92672">(</span>Pconst_integer <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;101&#34;</span>, None<span style="color:#f92672">))</span>;
</span></span><span style="display:flex;"><span>                 pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}}</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">{</span>pc_lhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_construct <span style="color:#f92672">({</span>txt <span style="color:#f92672">=</span> Lident <span style="color:#e6db74">&#34;Charlie&#34;</span><span style="color:#f92672">}</span>, None<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                 ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>;
</span></span><span style="display:flex;"><span>               pc_guard <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>               pc_rhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span> Pexp_constant <span style="color:#f92672">(</span>Pconst_integer <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;102&#34;</span>, None<span style="color:#f92672">))</span>;
</span></span><span style="display:flex;"><span>                 pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}}</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">{</span>pc_lhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>ppat_desc <span style="color:#f92672">=</span> Ppat_construct <span style="color:#f92672">({</span>txt <span style="color:#f92672">=</span> Lident <span style="color:#e6db74">&#34;David&#34;</span><span style="color:#f92672">}</span>, None<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                 ppat_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}</span>;
</span></span><span style="display:flex;"><span>               pc_guard <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>               pc_rhs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>pexp_desc <span style="color:#f92672">=</span> Pexp_constant <span style="color:#f92672">(</span>Pconst_integer <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;103&#34;</span>, None<span style="color:#f92672">))</span>;
</span></span><span style="display:flex;"><span>                 pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}}])</span>;
</span></span><span style="display:flex;"><span>           pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]})</span>;
</span></span><span style="display:flex;"><span>        pexp_loc_stack <span style="color:#f92672">=</span> <span style="color:#f92672">[]}}])}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=========</span>
</span></span></code></pre></div><p>The output is pretty straight forward. The <a href="https://caml.inria.fr/pub/docs/manual-ocaml/compilerlibref/Parsetree.html">Parsetree documentation</a> is a good reference to understand it.</p>
<hr>
<h2 id="typedtree">Typedtree<a hidden class="anchor" aria-hidden="true" href="#typedtree">#</a></h2>
<p>For the simplicity of the article, we will skip the detail of type inferencing and checking here. They will (hopefully) be explained in the future.</p>
<hr>
<h2 id="lambda">Lambda<a hidden class="anchor" aria-hidden="true" href="#lambda">#</a></h2>
<p>The first code generation phase in the OCaml pipeline is to create a <strong>Lambda Form</strong>. Lambda form discards higher-level constructs such as modules, pattern matching, and objects.</p>
<ul>
<li>Modules and objects are replaced with records and function pointers.</li>
<li>Pattern Matchings are compiled into optimized automatas.</li>
<li>Block and values are mapped to <a href="https://dev.realworldocaml.org/runtime-memory-layout.html#memory-representation-of-values">the runtime memory model</a>.</li>
</ul>
<p>We can obtain the lambda form via the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ocamlc -dlambda -c t.ml
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>setglobal T!
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>let
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>test/85 <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">(</span><span style="color:#66d9ef">function</span> v/87 : int
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">(</span>switch* v/87
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> int 0: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> int 1: <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> int 2: <span style="color:#ae81ff">102</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> int 3: 103<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>makeblock <span style="color:#ae81ff">0</span> test/85<span style="color:#f92672">)))</span>
</span></span></code></pre></div><p>Lambda Form is <strong>explicitly undocumented</strong> and can change across compiler revisions.</p>
<p>For more detail, see <a href="https://dev.realworldocaml.org/compiler-backend.html">The Compiler Backend: Bytecode and Native code - Real World OCaml</a>.</p>
<p>We can generate both <strong>bytecodes</strong> and <strong>native binaries</strong> from the Lambda Form.</p>
<hr>
<h2 id="bytecode-and-js_of_ocaml">Bytecode and <code>js_of_ocaml</code><a hidden class="anchor" aria-hidden="true" href="#bytecode-and-js_of_ocaml">#</a></h2>
<p>We can obtain the bytecode with the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ocamlc -dinstr t.ml
</span></span><span style="display:flex;"><span>	branch L2
</span></span><span style="display:flex;"><span>L1:	acc <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	switch <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">4</span> 3/
</span></span><span style="display:flex;"><span>L6:	const <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>L5:	const <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>L4:	const <span style="color:#ae81ff">102</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>L3:	const <span style="color:#ae81ff">103</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>L2:	closure L1, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	push
</span></span><span style="display:flex;"><span>	acc <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	makeblock 1, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	pop <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	setglobal T!
</span></span></code></pre></div><p>The bytecode can be executed with <code>ocamlrun</code>, a portable interpreter for OCaml&rsquo;s bytecode.</p>
<p>The OCaml bytecode is based on a stack-based VM. The instruction set of the Caml Virtual Machine is documented <a href="http://cadmium.x9c.fr/distrib/caml-instructions.pdf">here</a>.</p>
<p>Since the OCaml bytecode is quite stable. We can generate a target-specified code (such as Javascript for the web) from it without recompiling any library.</p>
<ul>
<li><a href="https://ocsigen.org/js_of_ocaml/"><code>js_of_ocaml</code></a> is a compiler from OCaml bytecode programs to Javascript.</li>
<li><a href="https://github.com/AbstractMachinesLab/caramel">Caramel</a> is an <a href="https://www.erlang.org/">Erlang</a> backend to the OCaml compiler.</li>
</ul>
<p>Here&rsquo;s a simple example of using <code>js_of_ocaml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ocamlfind ocamlc -package js_of_ocaml -package js_of_ocaml-ppx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -linkpkg -o t.byte t.ml
</span></span><span style="display:flex;"><span>$ js_of_ocaml t.byte
</span></span></code></pre></div><hr>
<h2 id="native-compilation">Native Compilation<a hidden class="anchor" aria-hidden="true" href="#native-compilation">#</a></h2>
<p>Finally, we can generate native binaries with <code>ocamlopt t.ml</code>. You can get <code>ocamlopt</code> to output the assembly with the <code>-S</code> flag.</p>
<p>If we want the best performance (and we usually does). We should use the compiler with <a href="https://caml.inria.fr/pub/docs/manual-ocaml/flambda.html">flambda optimizers</a>. you can install a flambda-optimized OCaml with <code>opam switch</code>, such as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ opam switch create 4.11.1+flambda
</span></span></code></pre></div><hr>
<h2 id="extra-top-level">Extra: Top-level<a hidden class="anchor" aria-hidden="true" href="#extra-top-level">#</a></h2>
<p>The OCaml top-level supports loading both source code or bytecodes. To load a source code, use the <code>#mod_use</code> command. To load a bytecode, use <code>#load</code>.</p>
<hr>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://sookocheff.com/post/ocaml/the-ocaml-compiler-pipeline/">The OCaml Compiler Pipeline</a></li>
<li><a href="https://dev.realworldocaml.org/compiler-frontend.html">The Compiler Frontend: Parsing and Type Checking</a></li>
<li><a href="https://dev.realworldocaml.org/compiler-backend.html">The Compiler Backend: Bytecode and Native code</a></li>
<li><a href="https://tarides.com/blog/2019-05-09-an-introduction-to-ocaml-ppx-ecosystem">An introduction to OCaml PPX ecosystem</a></li>
</ul>
<hr>
<p>Like this post? <a href="https://learnocamlthehardway.substack.com/welcome">Subscribe</a> to <strong>Learn OCaml the Hard Way</strong> to get more!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://devpoga.org/tags/ocaml/">OCaml</a></li>
      <li><a href="https://devpoga.org/tags/compiler/">Compiler</a></li>
      <li><a href="https://devpoga.org/tags/programming/">programming</a></li>
      <li><a href="https://devpoga.org/tags/learn-ocaml-the-hard-way/">Learn OCaml the Hard Way</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://devpoga.org/">Dev.Poga</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
