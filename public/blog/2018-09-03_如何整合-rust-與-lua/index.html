<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K4HXJ8V');</script>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>如何整合 Rust 與 Lua | Dev.Poga</title>
<meta name="keywords" content="Rust, Lua, Actix">
<meta name="description" content="

Photo by Anders Jildén on Unsplash
在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 Rust 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 Lua 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。
最近為了實做 actix-lua，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。">
<meta name="author" content="poga">
<link rel="canonical" href="https://devpoga.org/blog/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://devpoga.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://devpoga.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://devpoga.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://devpoga.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://devpoga.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://devpoga.org/blog/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="如何整合 Rust 與 Lua" />
<meta property="og:description" content="

Photo by Anders Jildén on Unsplash
在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 Rust 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 Lua 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。
最近為了實做 actix-lua，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devpoga.org/blog/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/" /><meta property="og:image" content="https://devpoga.org/post/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/images/1.jpeg" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-09-03T23:30:04+00:00" />
<meta property="article:modified_time" content="2019-04-30T21:56:04+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://devpoga.org/post/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/images/1.jpeg"/>

<meta name="twitter:title" content="如何整合 Rust 與 Lua"/>
<meta name="twitter:description" content="

Photo by Anders Jildén on Unsplash
在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 Rust 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 Lua 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。
最近為了實做 actix-lua，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://devpoga.org/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "如何整合 Rust 與 Lua",
      "item": "https://devpoga.org/blog/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "如何整合 Rust 與 Lua",
  "name": "如何整合 Rust 與 Lua",
  "description": " Photo by Anders Jildén on Unsplash\n在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 Rust 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 Lua 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。\n最近為了實做 actix-lua，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。\n",
  "keywords": [
    "Rust", "Lua", "Actix"
  ],
  "articleBody": " Photo by Anders Jildén on Unsplash\n在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 Rust 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 Lua 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。\n最近為了實做 actix-lua，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。\nLua Binding 的選擇 Rust 現在有數套 Lua binding，比較常被人提到的是 lua, hlua 與 rlua 。\nlua 基本上是直接把 Lua 的 C API 直接移植，沒有做多餘的包裝。所以需要絕對的效能的話，這可能是你的最佳選擇。不過安全性跟 UB 就要自己處理了。\nhlua 提供是比較高階的介面，不讓你直接存取 Lua Stack，可以視為 lua API 上的再一層包裝。彈性較低，可能不適合某些需求。\nrlua 是由知名遊戲工作室 chucklefish 開發。延續 Rust 對安全性的要求，設計介面時也是以安全性為最高原則。在使用 rlua 的 API 時，不會產生任何 UB（由於 lua API 跟內部的運作方式，這種 API 真的很難做到…）也許犧牲了一點效能，不過對於 Rust 的使用者來說，這樣的 tradeoff 應該是蠻值得的。\n最後我用的是 rlua。\n老問題：Lifetime \u0026 ownership 剛開始用 rlua 的時候，很容易就撞到 lifetime 的問題。不過，就跟一般使用 Rust 一樣：如果遇到很難解的 lifetime 跟 ownership 問題，很可能架構設計上就錯了。\nrlua 作者很詳盡的解釋了 rlua 許多的設計概念，也深入剖析了 Lua 本身設計帶來的影響。不過，這些解釋大多分散在各 github issue 之中。這邊稍微整理一下幾個重點：\nrlua 提供的所有的 reference type，像是 Function、 Table 這些指向 Lua 內部元素的參照，都不應該被另外存起來。 rlua 提供的 reference type 也不應該被存到任何 Lua 內的 userdata 或是 Rust callback 之中。 傳進 rlua 中的任何值都必須是 Send （因為 lua 本身是 Send）跟 'static（因為你沒辦法知道 Lua 何時會 GC 掉這些值，難以找出精確的 lifetime。） 3 的限制讓傳值給 lua 變的複雜許多。rlua 提供了 scope API，可以用一個暫時的 scope 將不符合條件的值傳給 lua。傳過去的資料在 scope 結束後就會被銷毀，避免複雜的 lifetime 問題。 最後的成果：actix-lua actix 是個 Rust 上的 actor framework，前陣子因為極高的效能而小有名氣。由於目前 Rust async/await 的支援還不算友善，actor model 算是能幫助簡化 async 程式的架構。\n而 actix-lua 便是將 actix 與 Lua 整合，讓人能用 Lua 實做系統中某些需要彈性、熱抽換、方便修改的部分。想法來自於 openresty 這套整合 nginx 與 Lua 的軟體。目前主要被我用來處理即時資料的分析。\n雖然寫的過程碰了蠻多壁，不過最後的成果我還算滿意。目前還在初步的階段，歡迎各種建議與回饋。\n",
  "wordCount" : "991",
  "inLanguage": "en",
  "datePublished": "2018-09-03T23:30:04Z",
  "dateModified": "2019-04-30T21:56:04+08:00",
  "author":{
    "@type": "Person",
    "name": "poga"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://devpoga.org/blog/2018-09-03_%E5%A6%82%E4%BD%95%E6%95%B4%E5%90%88-rust-%E8%88%87-lua/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dev.Poga",
    "logo": {
      "@type": "ImageObject",
      "url": "https://devpoga.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K4HXJ8V"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://devpoga.org/" accesskey="h" title="Dev.Poga (Alt + H)">Dev.Poga</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://devpoga.org/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://devpoga.org/">Home</a>&nbsp;»&nbsp;<a href="https://devpoga.org/blog/">Blogs</a></div>
    <h1 class="post-title">
      如何整合 Rust 與 Lua
    </h1>
    <div class="post-meta">&lt;span title=&#39;2018-09-03 23:30:04.764 &#43;0000 UTC&#39;&gt;September 3, 2018&lt;/span&gt;&amp;nbsp;·&amp;nbsp;poga

</div>
  </header> 
  <div class="post-content"><p><img loading="lazy" src="/post/2018-09-03_%e5%a6%82%e4%bd%95%e6%95%b4%e5%90%88-rust-%e8%88%87-lua/images/1.jpeg" alt="image"  />
</p>
<p>Photo by <a href="https://unsplash.com/photos/4izt8TxQmEs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Anders Jildén</a> on <a href="https://unsplash.com/search/photos/lua?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>
<p>在系統中遷入一個動態輕巧的 scripting language 一直是個常見的設計。像 <a href="https://www.rust-lang.org/">Rust</a> 這樣的系統語言，雖然效能好，但是上手門檻較高。這時若是能遷入一個像 <a href="https://www.lua.org/">Lua</a> 一樣動態型別，簡單易懂的語言，便能大幅提高系統彈性。</p>
<p>最近為了實做 <a href="https://github.com/poga/actix-lua">actix-lua</a>，研究了一下 Rust 跟 Lua 之間的介接，順便學了不少 Rust 跟 Lua 的設計，筆記在此。</p>
<h4 id="lua-binding-的選擇">Lua Binding 的選擇<a hidden class="anchor" aria-hidden="true" href="#lua-binding-的選擇">#</a></h4>
<p>Rust 現在有數套 Lua binding，比較常被人提到的是 <a href="https://crates.io/crates/lua">lua</a>, <a href="https://github.com/tomaka/hlua">hlua</a> 與 <a href="https://github.com/kyren/rlua">rlua</a> 。</p>
<p><a href="https://crates.io/crates/lua">lua</a> 基本上是直接把 Lua 的 C API 直接移植，沒有做多餘的包裝。所以需要絕對的效能的話，這可能是你的最佳選擇。不過安全性跟 UB 就要自己處理了。</p>
<p><a href="https://github.com/tomaka/hlua">hlua</a> 提供是比較高階的介面，不讓你直接存取 Lua Stack，可以視為 lua API 上的再一層包裝。彈性較低，可能不適合某些需求。</p>
<p><a href="https://github.com/kyren/rlua">rlua</a> 是由知名遊戲工作室 <a href="https://blog.chucklefish.org/about/">chucklefish</a> 開發。延續 Rust 對安全性的要求，設計介面時也是以安全性為最高原則。在使用 rlua 的 API 時，不會產生任何 UB（由於 lua API 跟內部的運作方式，這種 API 真的很難做到…）也許犧牲了一點效能，不過對於 Rust 的使用者來說，這樣的 tradeoff 應該是蠻值得的。</p>
<p>最後我用的是 rlua。</p>
<h4 id="老問題lifetime-amp-ownership">老問題：Lifetime &amp; ownership<a hidden class="anchor" aria-hidden="true" href="#老問題lifetime-amp-ownership">#</a></h4>
<p>剛開始用 rlua 的時候，很容易就撞到 lifetime 的問題。不過，就跟一般使用 Rust 一樣：如果遇到很難解的 lifetime 跟 ownership 問題，很可能架構設計上就錯了。</p>
<p>rlua 作者很詳盡的解釋了 rlua 許多的設計概念，也深入剖析了 Lua 本身設計帶來的影響。不過，這些解釋大多分散在各 github issue 之中。這邊稍微整理一下幾個重點：</p>
<ol>
<li>rlua 提供的所有的 reference type，像是 <code>Function</code>、 <code>Table</code> 這些指向 Lua 內部元素的參照，都不應該被另外存起來。</li>
<li>rlua 提供的 reference type 也不應該被存到任何 Lua 內的 <code>userdata</code> 或是 Rust callback 之中。</li>
<li>傳進 rlua 中的任何值都必須是 <code>Send</code> （因為 lua 本身是 <code>Send</code>）跟 <code>'static</code>（因為你沒辦法知道 Lua 何時會 GC 掉這些值，難以找出精確的 lifetime。）</li>
<li>3 的限制讓傳值給 lua 變的複雜許多。rlua 提供了 <code>scope</code> API，可以用一個暫時的 scope 將不符合條件的值傳給 lua。傳過去的資料在 scope 結束後就會被銷毀，避免複雜的 lifetime 問題。</li>
</ol>
<h4 id="最後的成果actix-lua">最後的成果：actix-lua<a hidden class="anchor" aria-hidden="true" href="#最後的成果actix-lua">#</a></h4>
<p><a href="https://actix.rs/">actix</a> 是個 Rust 上的 actor framework，前陣子因為極高的效能而小有名氣。由於目前 Rust async/await 的支援還不算友善，actor model 算是能幫助簡化 async 程式的架構。</p>
<p>而 <a href="https://github.com/poga/actix-lua">actix-lua</a> 便是將 actix 與 Lua 整合，讓人能用 Lua 實做系統中某些需要彈性、熱抽換、方便修改的部分。想法來自於 <a href="https://openresty.org/en/">openresty</a> 這套整合 nginx 與 Lua 的軟體。目前主要被我用來處理即時資料的分析。</p>
<p>雖然寫的過程碰了蠻多壁，不過最後的成果我還算滿意。目前還在初步的階段，歡迎各種建議與回饋。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://devpoga.org/tags/rust/">Rust</a></li>
      <li><a href="https://devpoga.org/tags/lua/">Lua</a></li>
      <li><a href="https://devpoga.org/tags/actix/">Actix</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://devpoga.org/">Dev.Poga</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
