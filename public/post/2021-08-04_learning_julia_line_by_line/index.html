<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>
      
      Learning Julia, Line by Line - Dev.Poga
      
		</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:image" content="https://devpoga.org/og.png" />

    
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/icons.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel="stylesheet">
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bigfoot/dist/bigfoot.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/bigfoot/dist/bigfoot-number.css" />
    <script type="text/javascript">
        $.bigfoot();
    </script>
    
    

    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-88018665-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-88018665-1');
</script>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>

    <body class="post-template">
        <header class="main-header">
	<div class="main-header-content">
    <img src="/me.jpg" class="avatar">
		<h1 class="blog-title">
			<a href="/">
				
           Dev.Poga
				
			</a>
		</h1>
		<h2 class="blog-description"></h2>
	</div>

	<div class="nav">
    
		
    
     <a href="https://devpoga.org/categories/notes/">Notes</a></li>
    
     <a href="https://devpoga.org/categories/essays/">Essays</a></li>
    
     <a href="https://devpoga.org/categories/papers/">Papers</a></li>
    
     <a href="https://devpoga.org/categories/talks/">Talks</a></li>
    
	</div>
</header>

        
<main class="content" role="main">
  <article class="post">
    <header class="post-header">
      <h2 class="post-title">Learning Julia, Line by Line</h2>
      <section class="post-meta">
        <time
          class="post-date"
          >2021-08-04</time
        >
        in
        <a href="https://devpoga.org/categories/notes/">Notes</a>
        
        
      </section>
    
    <aside>
      <nav id="TableOfContents"></nav>
      <hr />
    </aside>
    
    </header>
    <section class="post-content">
      <p><a href="https://github.com/StefanKarpinski/Cards.jl">Cardsjl</a> is a simple Julia package which demonstrate many interesting bits of the <a href="https://julialang.org/">Julia Programming Language</a>.</p>
<p>Reading it is an enjoyable experience. The note I&rsquo;ve writtend down is here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#75715e"># import base multiply(*), bitwise-or(|), and bitwise-and(&amp;)</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># In Julia, you can load modules with `using` or `import`. The difference is that</span>
<span style="color:#75715e"># * `using` will load the module **and** reexport the loaded module into the surrounding global</span>
<span style="color:#75715e">#    namespace.</span>
<span style="color:#75715e"># * `import` will only load the module and rexport the module name to the scope.</span>
<span style="color:#66d9ef">import</span> Base<span style="color:#f92672">:</span> <span style="color:#f92672">*</span>, <span style="color:#f92672">|</span>, <span style="color:#f92672">&amp;</span>


<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Encode a suit as a 2-bit value (low bits of a `UInt8`):
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">- 0 = ♣ (clubs)
</span><span style="color:#e6db74">- 1 = ♢ (diamonds)
</span><span style="color:#e6db74">- 2 = ♡ (hearts)
</span><span style="color:#e6db74">- 3 = ♠ (spades)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">The suits have global constant bindings: `♣`, `♢`, `♡`, `♠`.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#75715e"># Here we define a struct `Suit`. A `Suit` contains a `i` variable with type`UInt8`</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># In Julia, type objects are constructor functions. We can create new instance of the struct</span>
<span style="color:#75715e"># via calling the function `suit = Suit(0)`</span>
<span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">Suit</span>
  i<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt8</span>

  <span style="color:#75715e"># Here, we define an &#34;Inner Constructor Method&#34; to define constraints for the constructor</span>
  <span style="color:#75715e">#</span>
  <span style="color:#75715e"># This is also a neat example of Julia&#39;s unicode support. Yes, we can use ≤ as `&lt;=`.</span>
  Suit(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">≤</span> s <span style="color:#f92672">≤</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">?</span> new(s) <span style="color:#f92672">:</span>
  throw(<span style="color:#66d9ef">ArgumentError</span>(<span style="color:#e6db74">&#34;invalid suit number: </span><span style="color:#e6db74">$s</span><span style="color:#e6db74">&#34;</span>))
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># Julia&#39;s abstraction is mostly powered by multiple dispatch.</span>
<span style="color:#75715e"># Here we define a &#34;new dispatch&#34; for `char()` function to convert normal characters to a Suit.</span>
<span style="color:#75715e"># Therefore, whenever the `char()` function is applied with a `Suit`, this dispatch will be used.</span>
char(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> <span style="color:#66d9ef">Char</span>(<span style="color:#ae81ff">0x2663</span><span style="color:#f92672">-</span>s<span style="color:#f92672">.</span>i)
<span style="color:#75715e"># ... and some other helpers. They&#39;re surprisingly self-explanatory</span>
Base<span style="color:#f92672">.</span>string(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> string(char(s))
Base<span style="color:#f92672">.</span>show(io<span style="color:#f92672">::</span><span style="color:#66d9ef">IO</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> print(io, char(s))

<span style="color:#75715e"># In a normal poker deck, there&#39;s only 4 possible suits</span>
<span style="color:#75715e"># We can write readable codes with the power of unicode symbols in Julia</span>
<span style="color:#66d9ef">const</span> ♣ <span style="color:#f92672">=</span> Suit(<span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">const</span> ♢ <span style="color:#f92672">=</span> Suit(<span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">const</span> ♡ <span style="color:#f92672">=</span> Suit(<span style="color:#ae81ff">2</span>)
<span style="color:#66d9ef">const</span> ♠ <span style="color:#f92672">=</span> Suit(<span style="color:#ae81ff">3</span>)

<span style="color:#66d9ef">const</span> suits <span style="color:#f92672">=</span> [♣, ♢, ♡, ♠]

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Encode a playing card as a 6-bit integer (low bits of a `UInt8`):
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">- low bits represent rank from 0 to 15
</span><span style="color:#e6db74">- high bits represent suit (♣, ♢, ♡ or ♠)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Ranks are assigned as follows:
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">- numbered cards (2 to 10) have rank equal to their number
</span><span style="color:#e6db74">- jacks, queens and kings have ranks 11, 12 and 13
</span><span style="color:#e6db74">- there are low and high aces with ranks 1 and 14
</span><span style="color:#e6db74">- there are low and high jokers with ranks 0 and 15
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">This allows any of the standard orderings of cards ranks to be
</span><span style="color:#e6db74">achieved simply by choosing which aces or which jokers to use.
</span><span style="color:#e6db74">There are a total of 64 possible card values with this scheme,
</span><span style="color:#e6db74">represented by `UInt8` values `0x00` through `0x3f`.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#75715e"># A Card is a struct which encode the suit and the rank into a single UInt8</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># In most high-level languages, this would be kinda tedious to define.</span>
<span style="color:#75715e"># However, Julia demonstrated its expressiveness straight to the lowest level here.</span>
<span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">Card</span>
  value<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt8</span>
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># We create a new dispatch for `Card`&#39;s constructor.</span>
<span style="color:#75715e"># It will encode the rank and the suit into the UInt8</span>
<span style="color:#66d9ef">function</span> Card(r<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>)
  <span style="color:#ae81ff">0</span> <span style="color:#f92672">≤</span> r <span style="color:#f92672">≤</span> <span style="color:#ae81ff">15</span> <span style="color:#f92672">||</span> throw(<span style="color:#66d9ef">ArgumentError</span>(<span style="color:#e6db74">&#34;invalid card rank: </span><span style="color:#e6db74">$r</span><span style="color:#e6db74">&#34;</span>))
  <span style="color:#66d9ef">return</span> Card(((s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>) <span style="color:#f92672">|</span> (r <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>))
<span style="color:#66d9ef">end</span>
<span style="color:#75715e"># Another dispath when a suit is given instead of an integer for suit</span>
Card(r<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> Card(r, s<span style="color:#f92672">.</span>i)

<span style="color:#75715e"># These are getters for getting the rank or suit from a card</span>
suit(c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>) <span style="color:#f92672">=</span> Suit((<span style="color:#ae81ff">0x30</span> <span style="color:#f92672">&amp;</span> c<span style="color:#f92672">.</span>value) <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#ae81ff">4</span>)
rank(c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>) <span style="color:#f92672">=</span> (c<span style="color:#f92672">.</span>value <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0f</span>) <span style="color:#f92672">%</span> <span style="color:#66d9ef">Int8</span>

<span style="color:#75715e"># Lets define a new dispatch for Base.show to make it looks good when printed.</span>
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>show(io<span style="color:#f92672">::</span><span style="color:#66d9ef">IO</span>, c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>)
  r <span style="color:#f92672">=</span> rank(c)
  <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">≤</span> r <span style="color:#f92672">≤</span> <span style="color:#ae81ff">14</span>
    r <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">&amp;&amp;</span> print(io, <span style="color:#e6db74">&#39;1&#39;</span>)
    print(io, <span style="color:#e6db74">&#34;1234567890JQKA&#34;</span>[r])
  <span style="color:#66d9ef">else</span>
    print(io, <span style="color:#e6db74">&#39;\U1f0cf&#39;</span>)
  <span style="color:#66d9ef">end</span>
  print(io, suit(c))
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># In Julia, `2 * x` can be written as `2x`.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># By creating a new dispatch for the multiply operator `*`, we can write `2♣`</span>
<span style="color:#75715e"># and it will automatically converted to `Card(2, ♣)`. WOW fancy.</span>
<span style="color:#f92672">*</span>(r<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> Card(r, s)

<span style="color:#75715e"># However, &#34;J♣&#34; will not be treated as a multipication.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Here we use `@eval` macro to create these variables as consts.</span>
<span style="color:#75715e"># such lispy. I like it.</span>
<span style="color:#66d9ef">for</span> s <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#34;♣♢♡♠&#34;</span>, (r,f) <span style="color:#66d9ef">in</span> zip(<span style="color:#ae81ff">11</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span>, <span style="color:#e6db74">&#34;JQKA&#34;</span>)
  ss, sc <span style="color:#f92672">=</span> <span style="color:#66d9ef">Symbol</span>(s), <span style="color:#66d9ef">Symbol</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$f$s</span><span style="color:#e6db74">&#34;</span>)
  <span style="color:#a6e22e">@eval</span> (<span style="color:#66d9ef">export</span> <span style="color:#f92672">$</span>sc; <span style="color:#66d9ef">const</span> <span style="color:#f92672">$</span>sc <span style="color:#f92672">=</span> Card(<span style="color:#f92672">$</span>r,<span style="color:#f92672">$</span>ss))
<span style="color:#66d9ef">end</span>

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Represent a hand (set) of cards using a `UInt64` bit set.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#75715e"># we use an `UInt64` bit set to store what cards are presented in a hand</span>
<span style="color:#75715e"># since there&#39;s only 52 cards in a deck.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># We use `&lt;:` to indicate that a `Hand` is a subtype of a `AbstractSet{Card}`.</span>
<span style="color:#75715e"># Therefore, `Hand` can be used with all functions with compatiable dispatch to an `AbstractSet`.</span>
<span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">Hand</span> <span style="color:#f92672">&lt;:</span> <span style="color:#66d9ef">AbstractSet</span>{<span style="color:#66d9ef">Card</span>}
  cards<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt64</span>
  Hand(cards<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt64</span>) <span style="color:#f92672">=</span> new(cards)
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># convert card value to bit	set position</span>
bit(c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>) <span style="color:#f92672">=</span> one(<span style="color:#66d9ef">UInt64</span>) <span style="color:#f92672">&lt;&lt;</span> c<span style="color:#f92672">.</span>value
<span style="color:#75715e"># convert suit to bit set range</span>
bits(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> <span style="color:#66d9ef">UInt64</span>(<span style="color:#ae81ff">0xffff</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>(s<span style="color:#f92672">.</span>i)

<span style="color:#75715e"># a simple constructor to convert a set of cards to a bit set</span>
<span style="color:#66d9ef">function</span> Hand(cards)
  hand <span style="color:#f92672">=</span> Hand(zero(<span style="color:#66d9ef">UInt64</span>))
  <span style="color:#66d9ef">for</span> card <span style="color:#66d9ef">in</span> cards
    card <span style="color:#66d9ef">isa</span> Card <span style="color:#f92672">||</span> throw(<span style="color:#66d9ef">ArgumentError</span>(<span style="color:#e6db74">&#34;not a card: </span><span style="color:#e6db74">$repr</span><span style="color:#e6db74">(card)&#34;</span>))
    i <span style="color:#f92672">=</span> bit(card)
    hand<span style="color:#f92672">.</span>cards <span style="color:#f92672">&amp;</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> throw(<span style="color:#66d9ef">ArgumentError</span>(<span style="color:#e6db74">&#34;duplicate cards are not supported&#34;</span>))
    hand <span style="color:#f92672">=</span> Hand(hand<span style="color:#f92672">.</span>cards <span style="color:#f92672">|</span> i)
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">return</span> hand
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># Some more dispatches for our Hand type</span>
Base<span style="color:#f92672">.</span><span style="color:#66d9ef">in</span>(c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>, h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>) <span style="color:#f92672">=</span> (bit(c) <span style="color:#f92672">&amp;</span> h<span style="color:#f92672">.</span>cards) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
Base<span style="color:#f92672">.</span>length(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>) <span style="color:#f92672">=</span> count_ones(h<span style="color:#f92672">.</span>cards)
Base<span style="color:#f92672">.</span>isempty(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>) <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>cards <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
Base<span style="color:#f92672">.</span>lastindex(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>) <span style="color:#f92672">=</span> length(h)

<span style="color:#75715e"># Define an iterator for our Hand.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># We can define a parameter with default value with the syntax introduced here</span>
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>iterate(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt8</span> <span style="color:#f92672">=</span> trailing_zeros(h<span style="color:#f92672">.</span>cards) <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>)
  (h<span style="color:#f92672">.</span>cards <span style="color:#f92672">&gt;&gt;&gt;</span> s) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">return</span> nothing
  c <span style="color:#f92672">=</span> Card(s); s <span style="color:#f92672">+=</span> true
  c, s <span style="color:#f92672">+</span> trailing_zeros(h<span style="color:#f92672">.</span>cards <span style="color:#f92672">&gt;&gt;&gt;</span> s) <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># a non-bound-checked function to get a Card from a Hand</span>
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>unsafe_getindex(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>, i<span style="color:#f92672">::</span><span style="color:#66d9ef">UInt8</span>)
  card, s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x5</span>
  <span style="color:#66d9ef">while</span> true
    mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffff_ffff_ffff_ffff</span> <span style="color:#f92672">&gt;&gt;</span> (<span style="color:#ae81ff">0x40</span> <span style="color:#f92672">-</span> (<span style="color:#ae81ff">0x1</span><span style="color:#f92672">&lt;&lt;</span>s) <span style="color:#f92672">-</span> card)
    card <span style="color:#f92672">+=</span> <span style="color:#66d9ef">UInt8</span>(i <span style="color:#f92672">&gt;</span> count_ones(h<span style="color:#f92672">.</span>cards <span style="color:#f92672">&amp;</span> mask) <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>) <span style="color:#f92672">&lt;&lt;</span> s
    s <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">break</span>
    s <span style="color:#f92672">-=</span> <span style="color:#ae81ff">0x1</span>
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">return</span> Card(card)
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># To avoid having to convert from UInt8 to Integer constantly,</span>
<span style="color:#75715e"># we create a new dispatch for our unsafe_getindex for all Integeres</span>
Base<span style="color:#f92672">.</span>unsafe_getindex(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>, i<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>) <span style="color:#f92672">=</span> Base<span style="color:#f92672">.</span>unsafe_getindex(h, i <span style="color:#f92672">%</span> <span style="color:#66d9ef">UInt8</span>)

<span style="color:#75715e"># Finally, we wrap our not-so-safe fuction with a bounded-checked `getindex` function</span>
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>getindex(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>, i<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>)
  <span style="color:#75715e"># The `@boundscheck` macro allows the bound check to be ignored with `@inbound` macro</span>
  <span style="color:#a6e22e">@boundscheck</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">≤</span> i <span style="color:#f92672">≤</span> length(h) <span style="color:#f92672">||</span> throw(<span style="color:#66d9ef">BoundsError</span>(h,i))
  <span style="color:#66d9ef">return</span> Base<span style="color:#f92672">.</span>unsafe_getindex(h, i)
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># Make a `Hand` looks nice when printed</span>
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>show(io<span style="color:#f92672">::</span><span style="color:#66d9ef">IO</span>, hand<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>)
  <span style="color:#66d9ef">if</span> isempty(hand) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>get(io, <span style="color:#e6db74">:compact</span>, false)
    print(io, <span style="color:#e6db74">&#34;Hand([&#34;</span>)
    <span style="color:#66d9ef">for</span> card <span style="color:#66d9ef">in</span> hand
      print(io, card)
      (bit(card) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">≤</span> hand<span style="color:#f92672">.</span>cards <span style="color:#f92672">&amp;&amp;</span> print(io, <span style="color:#e6db74">&#34;, &#34;</span>)
    <span style="color:#66d9ef">end</span>
    print(io, <span style="color:#e6db74">&#34;])&#34;</span>)
  <span style="color:#66d9ef">else</span>
    <span style="color:#66d9ef">for</span> suit <span style="color:#66d9ef">in</span> suits
      s <span style="color:#f92672">=</span> hand <span style="color:#f92672">&amp;</span> suit
      isempty(s) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">continue</span>
      show(io, suit)
      <span style="color:#66d9ef">for</span> card <span style="color:#66d9ef">in</span> s
        r <span style="color:#f92672">=</span> rank(card)
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>
          print(io, <span style="color:#e6db74">&#39;\u2491&#39;</span>)
        <span style="color:#66d9ef">elseif</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">≤</span> r <span style="color:#f92672">≤</span> <span style="color:#ae81ff">14</span>
          print(io, <span style="color:#e6db74">&#34;1234567890JQKA&#34;</span>[r])
        <span style="color:#66d9ef">else</span>
          print(io, <span style="color:#e6db74">&#39;\U1f0cf&#39;</span>)
        <span style="color:#66d9ef">end</span>
      <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># More dispatch to allow us to combine two hands with `|`, add a card to a hand with `|`</span>
a<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">|</span> b<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">=</span> Hand(a<span style="color:#f92672">.</span>cards <span style="color:#f92672">|</span> b<span style="color:#f92672">.</span>cards)
a<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">|</span> c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span> <span style="color:#f92672">=</span> Hand(a<span style="color:#f92672">.</span>cards <span style="color:#f92672">|</span> bit(c))
c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span> <span style="color:#f92672">|</span> h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">=</span> h <span style="color:#f92672">|</span> c

<span style="color:#75715e"># interset two hands with `&amp;`</span>
a<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">&amp;</span> b<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">=</span> Hand(a<span style="color:#f92672">.</span>cards <span style="color:#f92672">&amp;</span> b<span style="color:#f92672">.</span>cards)
<span style="color:#75715e"># fetch cards within a suit range with `&amp;`</span>
h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">&amp;</span> s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span> <span style="color:#f92672">=</span> Hand(h<span style="color:#f92672">.</span>cards <span style="color:#f92672">&amp;</span> bits(s))
s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span> <span style="color:#f92672">&amp;</span> h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span> <span style="color:#f92672">=</span> h <span style="color:#f92672">&amp;</span> s

<span style="color:#75715e"># more new dispatches</span>
Base<span style="color:#f92672">.</span>intersect(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>, h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>) <span style="color:#f92672">=</span> h <span style="color:#f92672">&amp;</span> s
Base<span style="color:#f92672">.</span>intersect(h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> intersect(s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>, h<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>)

<span style="color:#75715e"># range operators for our suit and cards</span>
<span style="color:#f92672">*</span>(rr<span style="color:#f92672">::</span><span style="color:#66d9ef">OrdinalRange</span>{<span style="color:#f92672">&lt;:</span><span style="color:#66d9ef">Integer</span>}, s<span style="color:#f92672">::</span><span style="color:#66d9ef">Suit</span>) <span style="color:#f92672">=</span> Hand(Card(r,s) <span style="color:#66d9ef">for</span> r <span style="color:#66d9ef">in</span> rr)
  <span style="color:#f92672">..</span>(r<span style="color:#f92672">::</span><span style="color:#66d9ef">Integer</span>, c<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>) <span style="color:#f92672">=</span> (r<span style="color:#f92672">:</span>rank(c))<span style="color:#f92672">*</span>suit(c)
  <span style="color:#f92672">..</span>(a<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>, b<span style="color:#f92672">::</span><span style="color:#66d9ef">Card</span>) <span style="color:#f92672">=</span> suit(a) <span style="color:#f92672">==</span> suit(b) <span style="color:#f92672">?</span> rank(a)<span style="color:#f92672">..</span>b <span style="color:#f92672">:</span>
  throw(<span style="color:#66d9ef">ArgumentError</span>(<span style="color:#e6db74">&#34;card ranges need matching suits: </span><span style="color:#e6db74">$a</span><span style="color:#e6db74"> vs </span><span style="color:#e6db74">$b</span><span style="color:#e6db74">&#34;</span>))

<span style="color:#75715e"># FINALLY, we create a deck, which contains 52 unique cards</span>
<span style="color:#66d9ef">const</span> deck <span style="color:#f92672">=</span> Hand(Card(r,s) <span style="color:#66d9ef">for</span> s <span style="color:#66d9ef">in</span> suits <span style="color:#66d9ef">for</span> r <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span>)

<span style="color:#75715e"># An empty hand can be represented as 0</span>
Base<span style="color:#f92672">.</span>empty(<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{<span style="color:#66d9ef">Hand</span>}) <span style="color:#f92672">=</span> Hand(zero(<span style="color:#66d9ef">UInt64</span>))

<span style="color:#75715e"># Use `rand` to get a random subset of the deck</span>
<span style="color:#75715e"># we use @eval to interpolate all cards into this expression then evaluate it</span>
<span style="color:#a6e22e">@eval</span> Base<span style="color:#f92672">.</span>rand(<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{<span style="color:#66d9ef">Hand</span>}) <span style="color:#f92672">=</span> Hand(<span style="color:#f92672">$</span>(deck<span style="color:#f92672">.</span>cards) <span style="color:#f92672">&amp;</span> rand(<span style="color:#66d9ef">UInt64</span>))

<span style="color:#75715e"># In Julia, a function ends with `!` indicates that it&#39;s an in-place update function</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Here we define a `deal!` function to fill hands based on specified `counts` layout</span>
<span style="color:#66d9ef">function</span> deal!(counts<span style="color:#f92672">::</span><span style="color:#66d9ef">Vector</span>{<span style="color:#f92672">&lt;:</span><span style="color:#66d9ef">Integer</span>}, hands<span style="color:#f92672">::</span><span style="color:#66d9ef">AbstractArray</span>{<span style="color:#66d9ef">Hand</span>}, offset<span style="color:#f92672">::</span><span style="color:#66d9ef">Int</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
  <span style="color:#66d9ef">for</span> rank <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span>, suit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">while</span> true
      hand <span style="color:#f92672">=</span> rand(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>)
      <span style="color:#66d9ef">if</span> counts[hand] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
        counts[hand] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
        hands[offset <span style="color:#f92672">+</span> hand] <span style="color:#f92672">|=</span> Card(rank, suit)
        <span style="color:#66d9ef">break</span>
      <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">return</span> hands
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># Now let&#39;s define our `deal` function. It will deal cards to 4 people with the given count</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Default dispatch when no argument provided</span>
deal() <span style="color:#f92672">=</span> deal!(fill(<span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">4</span>), fill(empty(Hand), <span style="color:#ae81ff">4</span>))

<span style="color:#75715e"># a dispatch for `deal` when an `n` Int is provided</span>
<span style="color:#66d9ef">function</span> deal(n<span style="color:#f92672">::</span><span style="color:#66d9ef">Int</span>)
  counts <span style="color:#f92672">=</span> fill(<span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">4</span>)
  hands <span style="color:#f92672">=</span> fill(empty(Hand), <span style="color:#ae81ff">4</span>, n)
  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n
    deal!(fill!(counts, <span style="color:#ae81ff">13</span>), hands, <span style="color:#ae81ff">4</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">return</span> permutedims(hands)
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># calculate the points of a given hand</span>
<span style="color:#66d9ef">function</span> points(hand<span style="color:#f92672">::</span><span style="color:#66d9ef">Hand</span>)
  p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">for</span> rank <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span>, suit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>
    card <span style="color:#f92672">=</span> Card(rank, suit)
    p <span style="color:#f92672">+=</span> (rank<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">*</span>(card <span style="color:#66d9ef">in</span> hand)
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">return</span> p
<span style="color:#66d9ef">end</span>
</code></pre></div>

      <hr />
      <p>
        <em>Don’t miss the next story. Sign up for my occasional</em>
        <a href="https://poga.substack.com/"><em>email newsletter</em></a>
        <em>. Or check the</em>
        <a href="https://devpoga.org/"><em>About/FAQ</em></a>
        <em>page for more.</em>
      </p>
    </section>
    <footer class="post-footer">
      <section class="tags post-meta">
        Tagged
        <a href="https://devpoga.org/tags/notes/">#Notes</a>
        <a href="https://devpoga.org/tags/programming/">#Programming</a>
        <a href="https://devpoga.org/tags/julia/">#Julia</a>
        
      </section>
      
    </footer>
  </article>
</main>

        <footer class="site-footer">
  <section class="rss"><a class="subscribe-button icon-feed" href="/index.xml"></a></section>
  
  
  <section class="copyright">&copy; 2022 Dev.Poga</section>
</footer>




    </body>
</html>
